# Next Steps (2025-09-21)

## Completed Today
- Restored `scripts/run_simulation.py` after corruption.
- Integrated solver diagnostic fields (`solver_*`) into structured per-agent log (schema 1.4.1 already in logging module).
- Added regression test `tests/unit/test_solver_logging.py` verifying presence & basic sanity of solver metrics.

## Updated Task Status
- Per-round solver iteration metrics: COMPLETE (logging + test).

## Remaining High-Priority Items
1. A* Pathfinding Implementation
   - Implement deterministic A* (Manhattan grid, 4-neighborhood) with lexicographic tie-breaking.
   - Add unit tests: optimality on unobstructed grid, stable tie-break ordering, no movement when already in marketplace.
   - Performance: Precompute distance field for heuristic (h = L1 distance to any marketplace cell).
2. Cumulative Travel Expenditure Metric
   - Add per-agent cumulative movement cost (numéraire units) distinct from per-round wealth fields.
   - Log as `wealth_cumulative_travel_cost` (additive schema bump 1.4.2) unless metric can reuse existing field semantics.
3. Documentation / CHANGELOG
   - Add changelog entry for 1.4.1 (solver diagnostics) + forthcoming 1.4.2 plan.
4. Financing Mode Expansion (Future)
   - Wire TOTAL_WEALTH semantics into order sizing once research pivot requires it; add comparative scenario test.

## Notes
- Solver metrics test is intentionally lightweight (2 rounds) to keep CI fast.
- Tatonnement fields may remain null on pure fsolve path; test allows None.
- Once A* lands, add spatial fidelity test asserting path length equals Manhattan distance for static regime.

## Suggested Next Execution Order
1. Implement A* (foundational for upcoming spatial analysis).
2. Add cumulative travel cost logging (small additive change, quick win).
3. Update CHANGELOG & README instrumentation section.

---
Generated by AI assistant to preserve development continuity.﻿# NEXT STEPS (Post Phase A Completion)

Date: 2025-09-21
Status: Phase A COMPLETE (Diagnostics & Solver Unification)

## Completed This Phase
- Unified Walrasian solver (single robust implementation)
- Added ECON_SOLVER_ASSERT diagnostic guard layer
- Added ECON_ENABLE_TRAVEL_BUDGET feature toggle
- Updated README & SPECIFICATION with diagnostics section
- Expanded test suite (254 total) including shape & solver diagnostics
- Maintained 100% pass rate (economic + spatial + replay + HUD)

## Phase B Objectives (Performance & Liquidity Extensions)
1. Performance Harness
   - Profiling script for per-round solver timings (target: <0.5 ms/round @ 50 agents, G<=5)
   - Warm-start heuristics (reuse prior price vector when participant set stable)
   - Optional Jacobian caching for Cobb-Douglas case
2. Financing Mode Expansion
   - Implement `FinancingMode.TOTAL_WEALTH` pathway
   - Branch value-feasibility invariant (personal vs total) with explicit logging fields
   - Add comparative welfare + liquidity gap metrics
3. Pathfinding Upgrade
   - A* implementation under static additive regime
   - Precomputed distance field & fallback to greedy for tie cases
   - Deterministic tie-breaking & regression test for consistent path cost
4. Logging / Instrumentation
   - Add per-round solver iteration counts & fallback indicator
   - Optional compressed logging flag (gzip JSONL)
   - Increment schema minor version (1.3.x → 1.4.0) for additive fields
5. Travel-Cost Analysis Enhancements
   - Record per-agent cumulative travel expenditure (numéraire units)
   - Distinguish theoretical wealth vs travel-adjusted wealth in logs

## Phase C (Exploratory / Deferred)
- Local price formation prototypes (bilateral bargaining scaffold)
- Throughput capacity stress harness & queue dynamics
- Production & credit conceptual design documents
- Batch scenario runner with aggregate welfare report generation

## Risk & Mitigation Matrix
| Risk | Impact | Mitigation |
|------|--------|------------|
| Solver fallback frequency increases with scale | Higher round latency | Add instrumentation first, then optimize hotspots (Jacobian cache) |
| A* pathfinding adds overhead | Slows large-agent runs | Distance field + only recompute when obstacles change (none currently) |
| Financing mode proliferation complicates tests | Flaky invariants | Parametrized tests isolating invariants per mode |
| Schema drift | Parsing breakage | Strict additive changes + version bump + replay regression tests |

## Acceptance Criteria (Phase B)
- <5% performance variance across 3 consecutive runs (seeded) on reference hardware
- TOTAL_WEALTH financing mode passes all invariants (adjusted value feasibility)
- A* pathfinding path cost equals precomputed Manhattan distance baseline
- Schema 1.4.0 additive fields documented with migration note
- All tests >= 270 total, 100% pass

## Implementation Order Justification
1. Instrument (timings, iterations) before optimizing performance.
2. Implement financing mode with guarded tests to avoid silent invariant drift.
3. Introduce A* only after economic semantics extended (avoid overlapping complexity).
4. Logging additions last to keep schema churn minimal during core feature work.

## Open Questions
- Should travel cost deduction become a per-step immediate consumption event vs end-of-round budget adjustment? (Impacts utility timing.)
- Do we need an environment flag to freeze participant set for controlled solver warm-start experiments?
- How to represent liquidity gap decomposition with multiple financing modes simultaneously? (Multi-column vs stacked long format.)

## Next Action (When Resuming Work)
Begin with adding lightweight timing instrumentation around `solve_walrasian_equilibrium` (wall-clock + iteration/fallback counters) and expose via logging—prerequisite for Performance Harness tasks.
